<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Smartschool Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050815;
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .page {
      width: 100%;
      max-width: 1000px;
      padding: 16px 16px 24px;
      box-sizing: border-box;
    }
    .container {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(5, 8, 21, 0.9);
      border: 1px solid rgba(15, 23, 42, 0.9);
      margin-bottom: 12px;
    }
    h2 {
      margin: 0 0 6px;
      font-size: 1rem;
    }
    .subtitle {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    /* Top navigation tabs (page level) */
    .page-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(51, 65, 85, 0.9);
    }
    .page-tabs button {
      position: relative;
      font-size: 0.8rem;
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }
    .page-tabs button:hover {
      background: rgba(37, 99, 235, 0.25);
      transform: translateY(-1px);
    }
    .page-tabs button.active {
      background: #1d4ed8;
      color: #e5e7eb;
    }
    .tab-badge {
      position: absolute;
      top: -3px;
      right: -3px;
      min-width: 14px;
      height: 14px;
      padding: 0 4px;
      border-radius: 999px;
      background: #ef4444;
      color: #f9fafb;
      font-size: 0.65rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.95);
    }

    /* Leaderboard layout */
    #leaderboard-tab {
      padding: 4px 4px 0;
    }
    .leaderboard-card {
      border-radius: 16px;
      padding: 14px 16px;
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.25), transparent 60%),
                  rgba(15, 23, 42, 0.96);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(30, 64, 175, 0.8);
    }
    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 10px;
    }
    .leaderboard-title {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .leaderboard-subtitle {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .tabs {
      display: inline-flex;
      gap: 6px;
      margin: 4px 0 10px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.9);
    }
    .tabs button {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }
    .tabs button:hover {
      background: rgba(37, 99, 235, 0.25);
      transform: translateY(-1px);
    }
    .tabs button.active {
      background: #2563eb;
      color: #f9fafb;
    }

    .leaderboard-list {
      margin: 0;
      padding: 0;
      list-style: none;
      font-size: 0.8rem;
    }

    .leaderboard-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(51, 65, 85, 0.8);
      margin-bottom: 6px;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }
    /* Highlight voor #1 in ELK leaderboard */
    .leaderboard-row--top {
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.35), rgba(15, 23, 42, 0.95));
      border-color: rgba(59, 130, 246, 0.95);
      box-shadow: 0 12px 32px rgba(37, 99, 235, 0.7);
    }
    .leaderboard-row:hover {
      background: rgba(15, 23, 42, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.9);
    }

    .leaderboard-rank {
      font-weight: 600;
      color: #9ca3af;
      width: 1.5rem;
      text-align: center;
    }
    .leaderboard-name {
      font-weight: 500;
      color: #e5e7eb;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .leaderboard-score {
      font-variant-numeric: tabular-nums;
      color: #bfdbfe;
      font-weight: 500;
    }
    .leaderboard-name-badge {
      margin-right: 4px;
      font-weight: 600;
    }

    .empty-state {
      font-size: 0.85rem;
      opacity: 0.8;
      padding: 4px 2px;
    }

    /* Newsfeed */
    #news-tab {
      padding: 4px 4px 0;
    }
    .news-item {
      font-size: 0.8rem;
      margin-bottom: 4px;
    }
    .news-item time {
      opacity: 0.6;
      margin-right: 6px;
      font-size: 0.75rem;
    }

    /* Monthly quest tab */
    #quest-tab {
      padding: 4px 4px 0;
    }
    .quest-card {
      border-radius: 16px;
      padding: 14px 16px;
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.3), transparent 60%),
                  rgba(15, 23, 42, 0.98);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(37, 99, 235, 0.9);
      font-size: 0.85rem;
    }
    .quest-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .quest-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      border: 1px solid rgba(59, 130, 246, 0.9);
      font-size: 0.8rem;
      margin-bottom: 8px;
      color: #dbeafe;
    }
    .quest-badge span {
      font-variant-numeric: tabular-nums;
    }
    .quest-list {
      margin: 6px 0 0;
      padding-left: 16px;
      font-size: 0.8rem;
    }
    .quest-highlight {
      color: #bfdbfe;
      font-weight: 500;
    }
    .quest-current {
      margin-top: 6px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Page-level tabs -->
    <div class="page-tabs">
      <button id="tab-btn-leaderboard" class="active">Leaderboard</button>
      <button id="tab-btn-news">
        News
        <span id="badge-news" class="tab-badge" style="display:none;"></span>
      </button>
      <button id="tab-btn-quest">
        Monthly Quest
        <span id="badge-quest" class="tab-badge" style="display:none;"></span>
      </button>
    </div>

    <!-- Leaderboard tab -->
    <div class="container" id="leaderboard-tab">
      <div id="app">
        <p class="empty-state">Wacht op gegevens van de Smartschoolâ€‘extensieâ€¦</p>
      </div>
    </div>

    <!-- News tab -->
    <div class="container" id="news-tab" style="display:none;">
      <h2>Newsfeed</h2>
      <div class="subtitle">Laatste updates & events</div>
      <div id="news-list">
        <p class="empty-state">Nog geen nieuws. Check later opnieuw.</p>
      </div>
    </div>

    <!-- Monthly quest tab -->
    <div class="container" id="quest-tab" style="display:none;">
      <div class="quest-card" id="quest-card">
        <div class="quest-title" id="quest-title">Monthly Quest</div>
        <div class="quest-badge">
          <span id="quest-badge-emoji">ðŸŽ‡</span>
          <span id="quest-badge-name">Monthly Quest Winner</span>
        </div>
        <p class="subtitle" id="quest-description">
          Aan het einde van elke maand krijgt de nummer 1 van het maandâ€‘leaderboard een speciale badge
          vÃ³Ã³r zijn/haar naam. Je kunt meerdere badges stapelen, maar aan het begin van elk schooljaar
          starten we opnieuw.
        </p>
        <ul class="quest-list">
          <li>De winnaar is de speler met de hoogste <span class="quest-highlight">month score</span> op de laatste dag van de maand.</li>
          <li>Elke gewonnen maand voegt Ã©Ã©n extra badgeâ€‘prefix voor je naam toe.</li>
          <li>Alle badges worden gereset bij de start van een nieuw schooljaar.</li>
        </ul>
        <p class="quest-current" id="quest-current"></p>
      </div>
    </div>

    <div class="container">
      <p style="font-size:0.75rem; opacity:0.8; margin-top:4px;">
        <a href="https://github.com/superman2775/smartschool-results-leaderboard/wiki/Privacy-Policy"
           target="_blank"
           rel="noopener noreferrer"
           style="color:#93c5fd; text-decoration:underline;">
          Privacy Policy / Privacyverklaring
        </a>
      </p>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = "https://iqsshtqyhmqqttsxroiv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlxc3NodHF5aG1xcXR0c3hyb2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODM1NDAsImV4cCI6MjA4NzU1OTU0MH0.z9t6ErFXoHOjMG22Z-EIvStBh4ysXXoG1MyZTdycCtA";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const EXPECTED_PARENT_ORIGIN = "https://*.smartschool.be";

    const STORAGE_KEYS = {
      LAST_NEWS_DATE: "ss_lb_last_news_date",
      LAST_QUEST_MONTH: "ss_lb_last_quest_month"
    };

    const MONTHLY_QUESTS = {
      0:  { name: "New Year Challenge", emoji: "â„ï¸", prefix: "â„ï¸â”ƒ", color: "#bfdbfe" },
      1:  { name: "Valentine Challenge", emoji: "ðŸ’˜", prefix: "ðŸ’˜â”ƒ", color: "#fecaca" },
      2:  { name: "Spring Challenge", emoji: "ðŸ€", prefix: "ðŸ€â”ƒ", color: "#bbf7d0" },
      3:  { name: "Rainy Day Challenge", emoji: "ðŸŒ§ï¸", prefix: "ðŸŒ§ï¸â”ƒ", color: "#bae6fd" },
      4:  { name: "Flower Boost Challenge", emoji: "ðŸŒ¸", prefix: "ðŸŒ¸â”ƒ", color: "#fbcfe8" },
      5:  { name: "July Exam Challenge", emoji: "ðŸ“š", prefix: "ðŸ“šâ”ƒ", color: "#fde68a" },
      6:  { name: "Vacation Challenge 1", emoji: "â˜€ï¸", prefix: "â˜€ï¸â”ƒ", color: "#fed7aa" },
      7:  { name: "Vacation Challenge 2", emoji: "ðŸŒ…", prefix: "ðŸŒ…â”ƒ", color: "#fed7aa" },
      8:  { name: "Backâ€‘toâ€‘School Challenge", emoji: "ðŸ““", prefix: "ðŸ““â”ƒ", color: "#e5e7eb" },
      9:  { name: "Halloween Challenge", emoji: "ðŸŽƒ", prefix: "ðŸŽƒâ”ƒ", color: "#fed7aa" },
      10: { name: "Cozy Nights Challenge", emoji: "ðŸŒ™", prefix: "ðŸŒ™â”ƒ", color: "#c7d2fe" },
      11: { name: "Christmas Challenge", emoji: "ðŸŽ„", prefix: "ðŸŽ„â”ƒ", color: "#bbf7d0" }
    };

    const NEWS_ITEMS = [
      {
        id: "2026-02-28-notifications",
        date: "2026-02-28",
        text: "Meldingen toegevoegd voor nieuws."
      },
      {
        id: "2026-02-27-quest",
        date: "2026-02-27",
        text: "Monthly quest toegevoegd, kleine update met bugfixes."
      },
      {
        id: "2026-02-25-playtest",
        date: "2026-02-25",
        text: "Eerste playtest voor testers."
      },
      {
        id: "2026-02-24-nicknames",
        date: "2026-02-24",
        text: "Random nicknames toegevoegd om ongepaste namen te vermijden."
      },
      {
        id: "2026-02-23-first-test",
        date: "2026-02-23",
        text: "Eerste test versie van het Smartschool Results Leaderboard is live."
      }
    ];

    function getCurrentQuestConfig(date = new Date()) {
      const month = date.getMonth();
      return MONTHLY_QUESTS[month] || {
        name: "Monthly Quest",
        emoji: "ðŸŽ‡",
        prefix: "ðŸŽ‡â”ƒ",
        color: "#bfdbfe"
      };
    }

    function updateQuestUI() {
      const cfg = getCurrentQuestConfig();
      const title = document.getElementById("quest-title");
      const badgeEmoji = document.getElementById("quest-badge-emoji");
      const badgeName = document.getElementById("quest-badge-name");
      const questCurrent = document.getElementById("quest-current");
      const card = document.getElementById("quest-card");

      title.textContent = `Monthly Quest â€“ ${cfg.name}`;
      badgeEmoji.textContent = cfg.emoji;
      badgeName.textContent = `${cfg.name} Winner`;

      card.style.borderColor = "#2563eb";
      card.style.boxShadow = "0 18px 40px rgba(15, 23, 42, 0.9)";

      questCurrent.textContent = `Deze maand: "${cfg.name}". De nummer 1 van het maandâ€‘leaderboard krijgt een "${cfg.emoji}"â€‘badge voor de naam.`;
    }

    function updateTabBadgesInitial() {
      // NEWS badge: op basis van laatste news-item datum / id
      const latestNewsId = NEWS_ITEMS[0]?.id;
      const badgeNews = document.getElementById("badge-news");
      const lastNewsSeen = localStorage.getItem(STORAGE_KEYS.LAST_NEWS_DATE);

      if (latestNewsId && lastNewsSeen !== latestNewsId) {
        badgeNews.style.display = "inline-flex";
        badgeNews.textContent = "â—";
      } else {
        badgeNews.style.display = "none";
      }

      // QUEST badge: 1 badge per nieuwe maand die je nog niet hebt gezien
      const now = new Date();
      const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
      const lastQuestSeen = localStorage.getItem(STORAGE_KEYS.LAST_QUEST_MONTH);
      const badgeQuest = document.getElementById("badge-quest");

      if (lastQuestSeen !== monthKey) {
        badgeQuest.style.display = "inline-flex";
        badgeQuest.textContent = "â—";
      } else {
        badgeQuest.style.display = "none";
      }
    }

    function markNewsAsRead() {
      const latestNewsId = NEWS_ITEMS[0]?.id;
      if (!latestNewsId) return;
      localStorage.setItem(STORAGE_KEYS.LAST_NEWS_DATE, latestNewsId);
      const badgeNews = document.getElementById("badge-news");
      badgeNews.style.display = "none";
    }

    function markQuestAsRead() {
      const now = new Date();
      const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
      localStorage.setItem(STORAGE_KEYS.LAST_QUEST_MONTH, monthKey);
      const badgeQuest = document.getElementById("badge-quest");
      badgeQuest.style.display = "none";
    }

    function generateRandomName() {
      const adjectives = [
        "Snelle", "Slimme", "Gekke", "Stille", "Magische", "Sterke", "Blije", "Stoere", "Luidruchtige",
        "Sappige", "Luie", "Verwarde", "Dansende", "Chagrijnige", "Epische", "Knettergekke",
        "Vliegende", "Machtige", "Knorrige", "Kleverige", "Grappige", "Slaaploze", "Bezige",
        "Zingende", "Onzichtbare", "Hyperactieve", "Koek-etende", "Verdwaalde", "Snotterende",
        "Tijdreizende", "Panikerende", "Technische", "Digitale", "Sarcastische", "Rommelige",
        "Vergeetachtige", "Overdreven", "Koffieverslaafde", "Droomachtige", "Bezopen", "Onhandige"
      ];
      const animals = [
        "Panda", "Leeuw", "Uil", "Vos", "Dolfijn", "Olifant", "Tijger", "Wolf", "Egel", "Aap",
        "Eend", "Kat", "Krokodil", "PinguÃ¯n", "Beer", "Koe", "Wasbeer", "Giraffe", "Zebra",
        "Koelkast", "Broodrooster", "Pizza", "Appeltaart", "Theepot", "Koffiekopje", "Sok", "Stoel",
        "Toilet", "Laptop", "Kussen", "Kaars", "Emmer", "Fiets", "Tandenborstel", "Banaan",
        "Spaghetti", "Lamp", "Kast", "Telefoon", "Gamecontroller", "Kaasblokje", "Wifi-router",
        "Dokter", "Piratenkapitein", "Tovenaar", "Ninja", "Programmeur", "Dromer", "DJ", "Ridder",
        "Zwerver", "Student", "Bakker", "Barista", "Kabouter", "Superheld", "Cowboy", "Agent"
      ];
      const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const animal = animals[Math.floor(Math.random() * animals.length)];
      const num = Math.floor(Math.random() * 999);
      return `${adj}${animal}${num}`;
    }

    function getOrCreateLocalUser() {
      let userId = localStorage.getItem("ss_leaderboard_user_id");
      let displayName = localStorage.getItem("ss_leaderboard_display_name");
      if (!userId) {
        if (window.crypto && crypto.randomUUID) {
          userId = crypto.randomUUID();
        } else {
          userId = String(Date.now()) + Math.random().toString(16).slice(2);
        }
        localStorage.setItem("ss_leaderboard_user_id", userId);
      }
      if (!displayName) {
        displayName = generateRandomName();
        localStorage.setItem("ss_leaderboard_display_name", displayName);
      }
      return { userId, displayName };
    }

    async function upsertScore({ userId, displayName, scores, schoolYear }) {
      const { yearScore, weekScore, monthScore } = scores;

      const { data, error } = await supabaseClient
        .from("leaderboard_entries")
        .upsert(
          {
            instance_id: userId,
            display_name: displayName,
            score: yearScore,
            week_score: weekScore,
            month_score: monthScore,
            school_year: schoolYear
          },
          { onConflict: "instance_id" }
        )
        .select();

      if (error) {
        console.error("Supabase upsert error:", error);
      }
      return data;
    }

    async function updateDisplayName(newName) {
      const userId = localStorage.getItem("ss_leaderboard_user_id");
      if (!userId) {
        console.error("Geen lokale userId gevonden");
        return;
      }
      const trimmed = (newName || "").trim();
      if (!trimmed) return;

      const { data, error } = await supabaseClient
        .from("leaderboard_entries")
        .update({ display_name: trimmed })
        .eq("instance_id", userId)
        .select();

      if (error) {
        console.error("Supabase update error:", error);
        return;
      }
      localStorage.setItem("ss_leaderboard_display_name", trimmed);
      console.log("Naam geÃ¼pdatet naar:", trimmed, data);
      return trimmed;
    }

    function startOfWeek(d) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = (day === 0 ? -6 : 1) - day;
      date.setHours(0, 0, 0, 0);
      date.setDate(date.getDate() + diff);
      return date;
    }

    function startOfMonth(d) {
      const date = new Date(d);
      return new Date(date.getFullYear(), date.getMonth(), 1, 0, 0, 0, 0);
    }

    function isSameWeek(date, ref) {
      const d = new Date(date);
      const r = new Date(ref);
      const start = startOfWeek(r);
      const end = new Date(start);
      end.setDate(end.getDate() + 7);
      return d >= start && d < end;
    }

    function isSameMonth(date, ref) {
      const d = new Date(date);
      const r = new Date(ref);
      return d.getFullYear() === r.getFullYear() && d.getMonth() === r.getMonth();
    }

    function calcPeriodScoresFromEvaluations(evaluations, now = new Date()) {
      let weekEarned = 0, weekMax = 0;
      let monthEarned = 0, monthMax = 0;
      let yearEarned = 0, yearMax = 0;

      (evaluations || []).forEach(ev => {
        const percent = typeof ev.percent === "number" ? ev.percent : Number(ev.percent);
        if (Number.isNaN(percent)) return;

        const earned = percent;
        const max = 100;

        yearEarned += earned;
        yearMax += max;

        if (isSameMonth(ev.date, now)) {
          monthEarned += earned;
          monthMax += max;
        }
        if (isSameWeek(ev.date, now)) {
          weekEarned += earned;
          weekMax += max;
        }
      });

      return {
        weekScore: weekMax > 0 ? (weekEarned / weekMax) * 100 : 0,
        monthScore: monthMax > 0 ? (monthEarned / monthMax) * 100 : 0,
        yearScore: yearMax > 0 ? (yearEarned / yearMax) * 100 : 0
      };
    }

    async function fetchLeaderboardRange({ schoolYear, scoreField }) {
      const field = scoreField || "score";

      let query = supabaseClient
        .from("leaderboard_entries")
        .select(`display_name, ${field}, badge_count`)
        .order(field, { ascending: false })
        .limit(10);

      if (schoolYear) {
        query = query.eq("school_year", schoolYear);
      }

      const { data, error } = await query;
      if (error) {
        console.error("Supabase fetch error:", error);
        return [];
      }

      return (data || []).map(row => ({
        display_name: row.display_name,
        score: row[field],
        badge_count: row.badge_count || 0
      }));
    }

    function renderMultiLeaderboard({ payload, weekBoard, monthBoard, yearBoard, selfName, selfScore }) {
      const root = document.getElementById("app");
      root.innerHTML = "";

      const card = document.createElement("div");
      card.className = "leaderboard-card";

      const header = document.createElement("div");
      header.className = "leaderboard-header";

      const title = document.createElement("div");
      title.className = "leaderboard-title";
      title.textContent = `Leaderboard ${payload.yearLabel || ""}`;

      const subtitle = document.createElement("div");
      subtitle.className = "leaderboard-subtitle";
      subtitle.textContent = `Jouw score (schooljaar): ${selfScore.toFixed(2)}% Â· ${selfName}`;

      header.appendChild(title);
      header.appendChild(subtitle);
      card.appendChild(header);

      const tabs = document.createElement("div");
      tabs.className = "tabs";

      const tabDefs = [
        { id: "week", label: "Deze week", data: weekBoard },
        { id: "month", label: "Deze maand", data: monthBoard },
        { id: "year", label: "Dit schooljaar", data: yearBoard }
      ];

      const listContainer = document.createElement("div");
      const questCfg = getCurrentQuestConfig();

      function renderListFor(tabId) {
        const tabDef = tabDefs.find(t => t.id === tabId);
        const board = tabDef.data || [];

        listContainer.innerHTML = "";

        if (!board.length) {
          const p = document.createElement("p");
          p.className = "empty-state";
          p.textContent = "Nog geen spelers in dit leaderboard.";
          listContainer.appendChild(p);
          return;
        }

        const list = document.createElement("ul");
        list.className = "leaderboard-list";

        board.forEach((entry, index) => {
          const li = document.createElement("li");
          li.className = "leaderboard-row";

          // highlight top 1 in elke tab
          if (index === 0) {
            li.classList.add("leaderboard-row--top");
          }

          const rank = document.createElement("div");
          rank.className = "leaderboard-rank";
          rank.textContent = index + 1;

          const nameSpan = document.createElement("div");
          nameSpan.className = "leaderboard-name";

          const badgeCount = entry.badge_count || 0;
          if (badgeCount > 0) {
            const badgeSpan = document.createElement("span");
            badgeSpan.className = "leaderboard-name-badge";
            const repeatCount = Math.max(1, Math.min(badgeCount, 12));
            badgeSpan.style.color = "#bfdbfe";
            badgeSpan.textContent = questCfg.prefix.repeat(repeatCount);
            nameSpan.appendChild(badgeSpan);
          }

          const nameText = document.createElement("span");
          nameText.textContent = entry.display_name;
          nameSpan.appendChild(nameText);

          const scoreSpan = document.createElement("div");
          scoreSpan.className = "leaderboard-score";
          scoreSpan.textContent = `${Number(entry.score).toFixed(2)}%`;

          li.appendChild(rank);
          li.appendChild(nameSpan);
          li.appendChild(scoreSpan);
          list.appendChild(li);
        });

        listContainer.appendChild(list);
      }

      tabDefs.forEach(tabDef => {
        const btn = document.createElement("button");
        btn.textContent = tabDef.label;
        btn.addEventListener("click", () => {
          Array.from(tabs.children).forEach(child => child.classList.remove("active"));
          btn.classList.add("active");
          renderListFor(tabDef.id);
        });
        if (tabDef.id === "year") {
          btn.classList.add("active");
        }
        tabs.appendChild(btn);
      });

      card.appendChild(tabs);
      card.appendChild(listContainer);
      root.appendChild(card);

      renderListFor("year");
    }

    function renderNewsfeed() {
      const list = document.getElementById("news-list");
      list.innerHTML = "";
      if (!NEWS_ITEMS.length) {
        const p = document.createElement("p");
        p.className = "empty-state";
        p.textContent = "Nog geen nieuws. Check later opnieuw.";
        list.appendChild(p);
        return;
      }
      NEWS_ITEMS.forEach(item => {
        const p = document.createElement("p");
        p.className = "news-item";
        const t = document.createElement("time");
        t.textContent = item.date;
        p.appendChild(t);
        const span = document.createElement("span");
        span.textContent = item.text;
        p.appendChild(span);
        list.appendChild(p);
      });
    }

    renderNewsfeed();
    updateQuestUI();
    updateTabBadgesInitial();

    (function initPageTabs() {
      const btnLeaderboard = document.getElementById("tab-btn-leaderboard");
      const btnNews = document.getElementById("tab-btn-news");
      const btnQuest = document.getElementById("tab-btn-quest");

      const tabLeaderboard = document.getElementById("leaderboard-tab");
      const tabNews = document.getElementById("news-tab");
      const tabQuest = document.getElementById("quest-tab");

      function activate(tab) {
        btnLeaderboard.classList.toggle("active", tab === "leaderboard");
        btnNews.classList.toggle("active", tab === "news");
        btnQuest.classList.toggle("active", tab === "quest");

        tabLeaderboard.style.display = tab === "leaderboard" ? "block" : "none";
        tabNews.style.display = tab === "news" ? "block" : "none";
        tabQuest.style.display = tab === "quest" ? "block" : "none";

        if (tab === "news") {
          markNewsAsRead();
        }
        if (tab === "quest") {
          markQuestAsRead();
        }
      }

      btnLeaderboard.addEventListener("click", () => activate("leaderboard"));
      btnNews.addEventListener("click", () => activate("news"));
      btnQuest.addEventListener("click", () => activate("quest"));

      activate("leaderboard");
    })();

    window.addEventListener("message", async (event) => {
      // if (event.origin !== EXPECTED_PARENT_ORIGIN) return;

      const data = event.data;
      if (!data || data.type !== "smartschool-leaderboard-data") return;

      const payload = data.payload;

      const { userId, displayName } = getOrCreateLocalUser();
      const schoolYear = payload.yearId || null;

      const now = new Date();
      const scores = calcPeriodScoresFromEvaluations(payload.evaluations || [], now);

      await upsertScore({ userId, displayName, scores, schoolYear });

      const [weekBoard, monthBoard, yearBoard] = await Promise.all([
        fetchLeaderboardRange({ schoolYear, scoreField: "week_score" }),
        fetchLeaderboardRange({ schoolYear, scoreField: "month_score" }),
        fetchLeaderboardRange({ schoolYear, scoreField: "score" })
      ]);

      renderMultiLeaderboard({
        payload,
        weekBoard,
        monthBoard,
        yearBoard,
        selfName: displayName,
        selfScore: scores.yearScore
      });
    });
  </script>
</body>
</html>
