<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Smartschool Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050815;
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .page {
      width: 100%;
      max-width: 1000px;
      padding: 16px 16px 24px;
      box-sizing: border-box;
    }
    .container {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(5, 8, 21, 0.9);
      border: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 12px;
    }
    h2 {
      margin: 0 0 6px;
      font-size: 1rem;
    }
    .subtitle {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    /* Leaderboard layout */
    #app {
      padding: 14px 16px;
    }

    .leaderboard-card {
      border-radius: 16px;
      padding: 14px 16px;
      background: radial-gradient(circle at top, rgba(79, 70, 229, 0.2), transparent 55%),
                  rgba(9, 9, 20, 0.9);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 10px;
    }

    .leaderboard-title {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .leaderboard-subtitle {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .tabs {
      display: inline-flex;
      gap: 6px;
      margin: 4px 0 10px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .tabs button {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }
    .tabs button:hover {
      background: rgba(148, 163, 184, 0.25);
      transform: translateY(-1px);
    }
    .tabs button.active {
      background: #6366f1;
      color: #f9fafb;
    }

    .leaderboard-list {
      margin: 0;
      padding: 0;
      list-style: none;
      font-size: 0.8rem;
    }

    .leaderboard-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.25);
      margin-bottom: 6px;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    }

    .leaderboard-row:hover {
      background: rgba(30, 64, 175, 0.7);
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
    }

    .leaderboard-rank {
      font-weight: 600;
      color: #9ca3af;
      width: 1.5rem;
      text-align: center;
    }

    .leaderboard-name {
      font-weight: 500;
      color: #e5e7eb;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .leaderboard-score {
      font-variant-numeric: tabular-nums;
      color: #bbf7d0;
      font-weight: 500;
    }

    .empty-state {
      font-size: 0.85rem;
      opacity: 0.8;
      padding: 4px 2px;
    }

    /* Newsfeed */
    .news-item {
      font-size: 0.8rem;
      margin-bottom: 4px;
    }
    .news-item time {
      opacity: 0.6;
      margin-right: 6px;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="container" id="app">
      <p class="empty-state">Wacht op gegevens van de Smartschool‑extensie…</p>
    </div>

    <!-- Newsfeed -->
    <div class="container" id="news">
      <h2>Newsfeed</h2>
      <div class="subtitle">Laatste updates & events</div>
      <div id="news-list">
        <p class="empty-state">Nog geen nieuws. Check later opnieuw.</p>
      </div>
    </div>

    <div class="container">
      <p style="font-size:0.75rem; opacity:0.8; margin-top:4px;">
        <a href="https://github.com/superman2775/smartschool-results-leaderboard/wiki/Privacy-Policy"
           target="_blank"
           rel="noopener noreferrer"
           style="color:#9fc5ff; text-decoration:underline;">
          Privacy Policy / Privacyverklaring
        </a>
      </p>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = "https://iqsshtqyhmqqttsxroiv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlxc3NodHF5aG1xcXR0c3hyb2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODM1NDAsImV4cCI6MjA4NzU1OTU0MH0.z9t6ErFXoHOjMG22Z-EIvStBh4ysXXoG1MyZTdycCtA";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const EXPECTED_PARENT_ORIGIN = "https://*.smartschool.be";

    function generateRandomName() {
      const adjectives = [
        "Snelle", "Slimme", "Gekke", "Stille", "Magische", "Sterke", "Blije", "Stoere", "Luidruchtige",
        "Sappige", "Luie", "Verwarde", "Dansende", "Chagrijnige", "Epische", "Knettergekke",
        "Vliegende", "Machtige", "Knorrige", "Kleverige", "Grappige", "Slaaploze", "Bezige",
        "Zingende", "Onzichtbare", "Hyperactieve", "Koek-etende", "Verdwaalde", "Snotterende",
        "Tijdreizende", "Panikerende", "Technische", "Digitale", "Sarcastische", "Rommelige",
        "Vergeetachtige", "Overdreven", "Koffieverslaafde", "Droomachtige", "Bezopen", "Onhandige"
      ];
      const animals = [
        "Panda", "Leeuw", "Uil", "Vos", "Dolfijn", "Olifant", "Tijger", "Wolf", "Egel", "Aap",
        "Eend", "Kat", "Krokodil", "Pinguïn", "Beer", "Koe", "Wasbeer", "Giraffe", "Zebra",
        "Koelkast", "Broodrooster", "Pizza", "Appeltaart", "Theepot", "Koffiekopje", "Sok", "Stoel",
        "Toilet", "Laptop", "Kussen", "Kaars", "Emmer", "Fiets", "Tandenborstel", "Banaan",
        "Spaghetti", "Lamp", "Kast", "Telefoon", "Gamecontroller", "Kaasblokje", "Wifi-router",
        "Dokter", "Piratenkapitein", "Tovenaar", "Ninja", "Programmeur", "Dromer", "DJ", "Ridder",
        "Zwerver", "Student", "Bakker", "Barista", "Kabouter", "Superheld", "Cowboy", "Agent"
      ];
      const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const animal = animals[Math.floor(Math.random() * animals.length)];
      const num = Math.floor(Math.random() * 999);
      return `${adj}${animal}${num}`;
    }

    function getOrCreateLocalUser() {
      let userId = localStorage.getItem("ss_leaderboard_user_id");
      let displayName = localStorage.getItem("ss_leaderboard_display_name");
      if (!userId) {
        if (window.crypto && crypto.randomUUID) {
          userId = crypto.randomUUID();
        } else {
          userId = String(Date.now()) + Math.random().toString(16).slice(2);
        }
        localStorage.setItem("ss_leaderboard_user_id", userId);
      }
      if (!displayName) {
        displayName = generateRandomName();
        localStorage.setItem("ss_leaderboard_display_name", displayName);
      }
      return { userId, displayName };
    }

    async function upsertScore({ userId, displayName, scores, schoolYear }) {
      const { yearScore, weekScore, monthScore } = scores;

      const { data, error } = await supabaseClient
        .from("leaderboard_entries")
        .upsert(
          {
            instance_id: userId,
            display_name: displayName,
            score: yearScore,
            week_score: weekScore,
            month_score: monthScore,
            school_year: schoolYear
          },
          { onConflict: "instance_id" }
        )
        .select();

      if (error) {
        console.error("Supabase upsert error:", error);
      }
      return data;
    }

    // alleen via console gebruiken:
    // updateDisplayName("NieuweNaam123")
    async function updateDisplayName(newName) {
      const userId = localStorage.getItem("ss_leaderboard_user_id");
      if (!userId) {
        console.error("Geen lokale userId gevonden");
        return;
      }
      const trimmed = (newName || "").trim();
      if (!trimmed) return;

      const { data, error } = await supabaseClient
        .from("leaderboard_entries")
        .update({ display_name: trimmed })
        .eq("instance_id", userId)
        .select();

      if (error) {
        console.error("Supabase update error:", error);
        return;
      }
      localStorage.setItem("ss_leaderboard_display_name", trimmed);
      console.log("Naam geüpdatet naar:", trimmed, data);
      return trimmed;
    }

    function startOfWeek(d) {
      const date = new Date(d);
      const day = date.getDay(); // 0 = zondag, 1 = maandag
      const diff = (day === 0 ? -6 : 1) - day; // maandag als start
      date.setHours(0, 0, 0, 0);
      date.setDate(date.getDate() + diff);
      return date;
    }

    function startOfMonth(d) {
      const date = new Date(d);
      return new Date(date.getFullYear(), date.getMonth(), 1, 0, 0, 0, 0);
    }

    function isSameWeek(date, ref) {
      const d = new Date(date);
      const r = new Date(ref);
      const start = startOfWeek(r);
      const end = new Date(start);
      end.setDate(end.getDate() + 7);
      return d >= start && d < end;
    }

    function isSameMonth(date, ref) {
      const d = new Date(date);
      const r = new Date(ref);
      return d.getFullYear() === r.getFullYear() && d.getMonth() === r.getMonth();
    }

    function calcPeriodScoresFromEvaluations(evaluations, now = new Date()) {
      let weekEarned = 0, weekMax = 0;
      let monthEarned = 0, monthMax = 0;
      let yearEarned = 0, yearMax = 0;

      (evaluations || []).forEach(ev => {
        const percent = typeof ev.percent === "number" ? ev.percent : Number(ev.percent);
        if (Number.isNaN(percent)) return;

        const earned = percent;
        const max = 100;

        yearEarned += earned;
        yearMax += max;

        if (isSameMonth(ev.date, now)) {
          monthEarned += earned;
          monthMax += max;
        }
        if (isSameWeek(ev.date, now)) {
          weekEarned += earned;
          weekMax += max;
        }
      });

      return {
        weekScore: weekMax > 0 ? (weekEarned / weekMax) * 100 : 0,
        monthScore: monthMax > 0 ? (monthEarned / monthMax) * 100 : 0,
        yearScore: yearMax > 0 ? (yearEarned / yearMax) * 100 : 0
      };
    }

    async function fetchLeaderboardRange({ schoolYear, scoreField }) {
      const field = scoreField || "score";

      let query = supabaseClient
        .from("leaderboard_entries")
        .select(`display_name, ${field}`)
        .order(field, { ascending: false })
        .limit(10);

      if (schoolYear) {
        query = query.eq("school_year", schoolYear);
      }

      const { data, error } = await query;
      if (error) {
        console.error("Supabase fetch error:", error);
        return [];
      }

      return (data || []).map(row => ({
        display_name: row.display_name,
        score: row[field]
      }));
    }

    function renderMultiLeaderboard({ payload, weekBoard, monthBoard, yearBoard, selfName, selfScore }) {
      const root = document.getElementById("app");
      root.innerHTML = "";

      const card = document.createElement("div");
      card.className = "leaderboard-card";

      const header = document.createElement("div");
      header.className = "leaderboard-header";

      const title = document.createElement("div");
      title.className = "leaderboard-title";
      title.textContent = `Leaderboard ${payload.yearLabel || ""}`;

      const subtitle = document.createElement("div");
      subtitle.className = "leaderboard-subtitle";
      subtitle.textContent = `Jouw score (schooljaar): ${selfScore.toFixed(2)}% · ${selfName}`;

      header.appendChild(title);
      header.appendChild(subtitle);
      card.appendChild(header);

      const tabs = document.createElement("div");
      tabs.className = "tabs";

      const tabDefs = [
        { id: "week", label: "Deze week", data: weekBoard },
        { id: "month", label: "Deze maand", data: monthBoard },
        { id: "year", label: "Dit schooljaar", data: yearBoard }
      ];

      const listContainer = document.createElement("div");

      function renderListFor(tabId) {
        const tabDef = tabDefs.find(t => t.id === tabId);
        const board = tabDef.data || [];

        listContainer.innerHTML = "";

        if (!board.length) {
          const p = document.createElement("p");
          p.className = "empty-state";
          p.textContent = "Nog geen spelers in dit leaderboard.";
          listContainer.appendChild(p);
          return;
        }

        const list = document.createElement("ul");
        list.className = "leaderboard-list";

        board.forEach((entry, index) => {
          const li = document.createElement("li");
          li.className = "leaderboard-row";

          const rank = document.createElement("div");
          rank.className = "leaderboard-rank";
          rank.textContent = index + 1;

          const nameSpan = document.createElement("div");
          nameSpan.className = "leaderboard-name";
          nameSpan.textContent = entry.display_name;

          const scoreSpan = document.createElement("div");
          scoreSpan.className = "leaderboard-score";
          scoreSpan.textContent = `${Number(entry.score).toFixed(2)}%`;

          li.appendChild(rank);
          li.appendChild(nameSpan);
          li.appendChild(scoreSpan);
          list.appendChild(li);
        });

        listContainer.appendChild(list);
      }

      tabDefs.forEach(tabDef => {
        const btn = document.createElement("button");
        btn.textContent = tabDef.label;
        btn.addEventListener("click", () => {
          Array.from(tabs.children).forEach(child => child.classList.remove("active"));
          btn.classList.add("active");
          renderListFor(tabDef.id);
        });
        if (tabDef.id === "year") {
          btn.classList.add("active");
        }
        tabs.appendChild(btn);
      });

      card.appendChild(tabs);
      card.appendChild(listContainer);
      root.appendChild(card);

      renderListFor("year");
    }

    const NEWS_ITEMS = [
      {
        date: "2026-02-25",
        text: "Eerste playtest voor testers."
      },
      {
        date: "2026-02-24",
        text: "Random nicknames toegevoegd om ongepaste namen te vermijden."
      },
      {
        date: "2026-02-23",
        text: "Eerste test versie van het Smartschool Results Leaderboard is live."
      }
    ];

    function renderNewsfeed() {
      const list = document.getElementById("news-list");
      list.innerHTML = "";
      if (!NEWS_ITEMS.length) {
        const p = document.createElement("p");
        p.className = "empty-state";
        p.textContent = "Nog geen nieuws. Check later opnieuw.";
        list.appendChild(p);
        return;
      }
      NEWS_ITEMS.forEach(item => {
        const p = document.createElement("p");
        p.className = "news-item";
        const t = document.createElement("time");
        t.textContent = item.date;
        p.appendChild(t);
        const span = document.createElement("span");
        span.textContent = item.text;
        p.appendChild(span);
        list.appendChild(p);
      });
    }

    renderNewsfeed();

    window.addEventListener("message", async (event) => {
      // if (event.origin !== EXPECTED_PARENT_ORIGIN) return;

      const data = event.data;
      if (!data || data.type !== "smartschool-leaderboard-data") return;

      const payload = data.payload; // { yearId, yearLabel, globalAvg, evaluations }

      const { userId, displayName } = getOrCreateLocalUser();
      const schoolYear = payload.yearId || null;

      const now = new Date();
      const scores = calcPeriodScoresFromEvaluations(payload.evaluations || [], now);

      await upsertScore({ userId, displayName, scores, schoolYear });

      const [weekBoard, monthBoard, yearBoard] = await Promise.all([
        fetchLeaderboardRange({ schoolYear, scoreField: "week_score" }),
        fetchLeaderboardRange({ schoolYear, scoreField: "month_score" }),
        fetchLeaderboardRange({ schoolYear, scoreField: "score" })
      ]);

      renderMultiLeaderboard({
        payload,
        weekBoard,
        monthBoard,
        yearBoard,
        selfName: displayName,
        selfScore: scores.yearScore
      });
    });
  </script>
</body>
</html>
