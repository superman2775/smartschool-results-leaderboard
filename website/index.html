<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Smartschool Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050815;
      color: #f5f5f5;
    }
    .container {
      padding: 10px 12px;
    }
    h2 {
      margin: 0 0 6px;
      font-size: 1rem;
    }
    .subtitle {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .tabs button {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.3);
      background: transparent;
      color: #fff;
      cursor: pointer;
    }
    .tabs button.active {
      background: rgba(255,255,255,0.15);
    }
    ol {
      margin: 0;
      padding-left: 16px;
      font-size: 0.8rem;
    }
    li {
      margin-bottom: 4px;
    }
    .course-name {
      font-weight: 600;
    }
    .course-score {
      margin-left: 6px;
      opacity: 0.9;
    }
    .empty-state {
      font-size: 0.85rem;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <p class="empty-state">Wacht op gegevens van de Smartschool‑extensie…</p>
  </div>
  <div class="container">
    <p style="font-size:0.75rem; opacity:0.8; margin-top:4px;">
      <a href="https://github.com/superman2775/smartschool-results-leaderboard/wiki/Privacy-Policy"
         target="_blank"
         rel="noopener noreferrer"
         style="color:#9fc5ff; text-decoration:underline;">
        Privacy Policy / Privacyverklaring
      </a>
    </p>
  </div>


  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = "https://iqsshtqyhmqqttsxroiv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlxc3NodHF5aG1xcXR0c3hyb2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODM1NDAsImV4cCI6MjA4NzU1OTU0MH0.z9t6ErFXoHOjMG22Z-EIvStBh4ysXXoG1MyZTdycCtA";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const EXPECTED_PARENT_ORIGIN = "https://martinusasse.smartschool.be"; // of "*" tijdens debug

    function generateRandomName() {
      const adjectives = ["Snelle", "Slimme", "Gekke", "Stille", "Magische", "Sterke", "Blije", "Stoere", "Luidruchtige"];
      const animals = ["Panda", "Leeuw", "Uil", "Vos", "Dolfijn", "Olifant", "Havik", "Tijger", "Wolf"];
      const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const animal = animals[Math.floor(Math.random() * animals.length)];
      const num = Math.floor(Math.random() * 999);
      return `${adj}${animal}${num}`;
    }

    function getOrCreateLocalUser() {
      let userId = localStorage.getItem("ss_leaderboard_user_id");
      let displayName = localStorage.getItem("ss_leaderboard_display_name");
      if (!userId) {
        if (window.crypto && crypto.randomUUID) {
          userId = crypto.randomUUID();
        } else {
          userId = String(Date.now()) + Math.random().toString(16).slice(2);
        }
        localStorage.setItem("ss_leaderboard_user_id", userId);
      }
      if (!displayName) {
        displayName = generateRandomName();
        localStorage.setItem("ss_leaderboard_display_name", displayName);
      }
      return { userId, displayName };
    }

    async function upsertScore({ userId, displayName, score, schoolYear }) {
      const { data, error } = await supabaseClient
        .from("leaderboard_entries")
        .upsert(
          {
            instance_id: userId,
            display_name: displayName,
            score,
            school_year: schoolYear
          },
          { onConflict: "instance_id" }
        )
        .select();

      if (error) {
        console.error("Supabase upsert error:", error);
      }
      return data;
    }

    // alleen via console gebruiken:
    // updateDisplayName("NieuweNaam123")
    async function updateDisplayName(newName) {
      const userId = localStorage.getItem("ss_leaderboard_user_id");
      if (!userId) {
        console.error("Geen lokale userId gevonden");
        return;
      }
      const trimmed = (newName || "").trim();
      if (!trimmed) return;

      const { data, error } = await supabaseClient
        .from("leaderboard_entries")
        .update({ display_name: trimmed })
        .eq("instance_id", userId)
        .select();

      if (error) {
        console.error("Supabase update error:", error);
        return;
      }
      localStorage.setItem("ss_leaderboard_display_name", trimmed);
      console.log("Naam geüpdatet naar:", trimmed, data);
      return trimmed;
    }

    function startOfWeek(d) {
      const date = new Date(d);
      const day = date.getDay(); // 0 = zondag, 1 = maandag
      const diff = (day === 0 ? -6 : 1) - day; // maandag als start
      date.setHours(0, 0, 0, 0);
      date.setDate(date.getDate() + diff);
      return date;
    }

    function startOfMonth(d) {
      const date = new Date(d);
      return new Date(date.getFullYear(), date.getMonth(), 1, 0, 0, 0, 0);
    }

    async function fetchLeaderboardRange({ schoolYear, from, to }) {
      let query = supabaseClient
        .from("leaderboard_entries")
        .select("display_name, score, created_at")
        .order("score", { ascending: false })
        .limit(10);

      if (schoolYear) {
        query = query.eq("school_year", schoolYear);
      }
      if (from) {
        query = query.gte("created_at", from.toISOString());
      }
      if (to) {
        query = query.lte("created_at", to.toISOString());
      }

      const { data, error } = await query;
      if (error) {
        console.error("Supabase fetch error:", error);
        return [];
      }
      return data || [];
    }

    function renderMultiLeaderboard({ payload, weekBoard, monthBoard, yearBoard, selfName, selfScore }) {
      const root = document.getElementById("app");
      root.innerHTML = "";

      const title = document.createElement("h2");
      title.textContent = `Leaderboard ${payload.yearLabel || ""}`;
      root.appendChild(title);

      const subtitle = document.createElement("div");
      subtitle.className = "subtitle";
      subtitle.textContent = `Jouw score: ${selfScore.toFixed(2)}% (${selfName})`;
      root.appendChild(subtitle);

      const tabs = document.createElement("div");
      tabs.className = "tabs";

      const tabDefs = [
        { id: "week", label: "Deze week", data: weekBoard },
        { id: "month", label: "Deze maand", data: monthBoard },
        { id: "year", label: "Dit schooljaar", data: yearBoard }
      ];

      const listContainer = document.createElement("div");

      function renderListFor(tabId) {
        const tabDef = tabDefs.find(t => t.id === tabId);
        const board = tabDef.data || [];

        listContainer.innerHTML = "";

        if (!board.length) {
          const p = document.createElement("p");
          p.className = "empty-state";
          p.textContent = "Nog geen spelers in dit leaderboard.";
          listContainer.appendChild(p);
          return;
        }

        const list = document.createElement("ol");
        board.forEach(entry => {
          const li = document.createElement("li");

          const nameSpan = document.createElement("span");
          nameSpan.className = "course-name";
          nameSpan.textContent = entry.display_name;

          const scoreSpan = document.createElement("span");
          scoreSpan.className = "course-score";
          scoreSpan.textContent = `${Number(entry.score).toFixed(2)}%`;

          li.appendChild(nameSpan);
          li.appendChild(scoreSpan);
          list.appendChild(li);
        });

        listContainer.appendChild(list);
      }

      tabDefs.forEach(tabDef => {
        const btn = document.createElement("button");
        btn.textContent = tabDef.label;
        btn.addEventListener("click", () => {
          Array.from(tabs.children).forEach(child => child.classList.remove("active"));
          btn.classList.add("active");
          renderListFor(tabDef.id);
        });
        if (tabDef.id === "year") {
          btn.classList.add("active");
        }
        tabs.appendChild(btn);
      });

      root.appendChild(tabs);
      root.appendChild(listContainer);

      renderListFor("year");
    }

    window.addEventListener("message", async (event) => {
      // if (event.origin !== EXPECTED_PARENT_ORIGIN) return;

      const data = event.data;
      if (!data || data.type !== "smartschool-leaderboard-data") return;

      const payload = data.payload; // { yearId, yearLabel, globalAvg, courses }

      const { userId, displayName } = getOrCreateLocalUser();
      const score = Number(payload.globalAvg.toFixed(2));
      const schoolYear = payload.yearId || null;

      await upsertScore({ userId, displayName, score, schoolYear });

      const now = new Date();
      const weekStart = startOfWeek(now);
      const monthStart = startOfMonth(now);

      const [weekBoard, monthBoard, yearBoard] = await Promise.all([
        fetchLeaderboardRange({ schoolYear, from: weekStart, to: now }),
        fetchLeaderboardRange({ schoolYear, from: monthStart, to: now }),
        fetchLeaderboardRange({ schoolYear, from: null, to: now })
      ]);
      
      renderMultiLeaderboard({
        payload,
        weekBoard,
        monthBoard,
        yearBoard,
        selfName: displayName,
        selfScore: score
      });
    });
  </script>
</body>
</html>
